<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/fontawesome.min.css"
        integrity="sha512-kJ30H6g4NGhWopgdseRb8wTsyllFUYIx3hiUwmGAkgA9B/JbzUBDQVr2VVlWGde6sdBVOG7oU8AL35ORDuMm8g=="
        crossorigin="anonymous" />
    <link rel="stylesheet" href="css/app.css">
    <style>
        .bottom-spacer {
            height: 100px;
        }
    </style>

    <title>Speech to Text</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a href="https://www.uihealthcare.org" class="navbar-brand" target="_blank">
            <img src="images/sig_logo.png" alt="UIHC Logo">
        </a>
        <a class="navbar-brand app-name" href="#">Navbar</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
            aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
                <a class="nav-link" href="#">Home</a>
                <a class="nav-link active" href="#">Evals <span class="sr-only">(current)</span></a>
                <a class="nav-link" href="#">Settings</a>
            </div>
        </div>
    </nav>
    <div class="container">
        <ul class="nav nav-pills m-3">
            <li class="nav-item">
                <a class="nav-link" href="index.html">As Envisioned</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="classic.html">Comparison to Classic Matrix</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="both.html">Both</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="faq.html">FAQ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="#">Speech to Text</a>
            </li>
        </ul>

        <h3 class="mb-4">Speech to Text Example</h3>

        <div class="alert alert-danger d-none" id="unsupported-message">
            <p class="mb-0"><strong>This browser does not support speech to text.</strong> Current versions of Google Chrome and Microsoft Edge will work.</p>
        </div>

        <div class="alert alert-info">
            <p class="mb-0">Test speech to text recognition in your browser on this page. Speech to text is implemented by your
                browser, not by CCOM. See <a href="faq.html#speech-to-text">Speech to Text</a> in the FAQ for more information.</p>
        </div>

        <h5>Instructions</h5>
        <p>Click the <span class="btn btn-sm btn-outline-secondary"><i class="fa-fw fas fa-microphone"></i></span> button to start recording text for the associated field. The input field will populate with the text result shortly after you stop speaking.</p>
        <p>Click the <span class="btn btn-sm btn-danger"><i class="fa-fw fas fa-microphone"></i></span> button to stop recording (it may stop on its own, see below).</p>

        <h3>Non-Continuous Speech Input</h3>
        <div class="alert alert-secondary">
            <p class="mb-0">
                With <strong>non-continuous</strong> speech input the the browser will automatically stop recording after a short
                break in your speech. For this page you can also click the red recording button to stop recording (it will also stop
                if you start recording on a different field). Also for this page only, if the recording stops and you click to record
                again it will add to your existing text instead of overwriting it.
            </p>
        </div>
        <label for="exampleTextInput">Text Non-Continuous Input</label>
        <div class="input-group mb-3" data-speech="true" data-speech-continuous="false">
            <input type="text" class="form-control" id="exampleTextInput">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" data-speech-record="true"
                    data-speech-target="#exampleTextInput">
                    <i class="fa-fw fas fa-microphone"></i>
                </button>
            </div>
        </div>

        <label for="exampleTextarea">Text Area Non-Continuous Input</label>
        <div class="input-group mb-3" data-speech="true" data-speech-continuous="false">
            <textarea class="form-control" id="exampleTextarea" rows="3"></textarea>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" data-speech-record="true"
                    data-speech-target='#exampleTextarea'>
                    <i class="fa-fw fas fa-microphone"></i>
                </button>
            </div>
        </div>

        <h3>Continuous Speech Input</h3>
        <div class="alert alert-secondary">
            <p class="mb-0">With <strong>continuous</strong> speech input the the browser will not stop recording until it is told to stop recording. For this page click the red recording button to stop (it will also stop if you start recording on a different field).</p>
        </div>
        <label for="exampleTextInput2">Text Continuous Input</label>
        <div class="input-group mb-3" data-speech="true" data-speech-continuous="true">
            <input type="text" class="form-control" id="exampleTextInput2">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" data-speech-record="true"
                    data-speech-target="#exampleTextInput2">
                    <i class="fa-fw fas fa-microphone"></i>
                </button>
            </div>
        </div>


        <label for="exampleTextarea2">Text Area Continous Input</label>
        <div class="input-group mb-3" data-speech="true" data-speech-continuous="true">
            <textarea class="form-control" id="exampleTextarea2" rows="3"></textarea>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" data-speech-record="true"
                    data-speech-target='#exampleTextarea2'>
                    <i class="fa-fw fas fa-microphone"></i>
                </button>
            </div>
        </div>


        <div class="bottom-spacer"></div>

    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/all.min.js"
        integrity="sha512-F5QTlBqZlvuBEs9LQPqc1iZv2UMxcVXezbHzomzS6Df4MZMClge/8+gXrKw2fl5ysdk4rWjR0vKS7NNkfymaBQ=="
        crossorigin="anonymous"></script>
    <script>
        var webkitUndef = window.webkitSpeechRecognition === undefined;
        var recogUndef = window.SpeechRecognition === undefined;

        if(window.webkitSpeechRecognition === undefined) {
            window.webkitSpeechRecognition = undefined;
        }

        if(window.SpeechRecognition === undefined) {
            window.SpeechRecognition = undefined;
        }

        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;

        var currentSpeech = {
            recog: null,
            stopCallback: null
        };

        function supportedEach(idx, el) {
            var theContainer = $(el);

            if (!theContainer.hasClass('not-recording')) {
                theContainer.addClass('not-recording');
            }

            var theButton = theContainer.find('button[data-speech-record="true"]');
            if (theButton.length == 0) {
                console.log('No recording button found');
                return;
            } else if (theButton.length > 1) {
                console.log('More than one recording button found');
                return;
            }

            var targetSelector = theButton.data('speech-target');
            if (typeof targetSelector != 'string') {
                console.log('Missing data-speech-target');
                return;
            }

            var theInput = $(targetSelector);
            if (theInput.lengt == 0) {
                console.log('Cound\'t find speech target of data-speech-target');
                return;
            } else if (theInput.length > 1) {
                console.log('More than one element matches the data-speech-target selector');
                return;
            }

            var recognition = new SpeechRecognition();
            recognition.continuous = theContainer.data('speech-continuous') == true;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            function startRecognition() {
                theContainer.removeClass('not-recording');
                theContainer.addClass('is-recording');
                theButton.removeClass('btn-outline-secondary');
                theButton.addClass('btn-danger');
                
                recognition.start();
            }

            function stopRecognition() {
                theContainer.removeClass('is-recording');
                theContainer.addClass('not-recording');
                theButton.removeClass('btn-danger');
                theButton.addClass('btn-outline-secondary');

                recognition.stop();
            }

            function appendToOutput(newText){
                var old = '';
                newText = newText || '';
                old = theInput.val() + ' ' + newText;
                theInput.val(old);
            }

            function extractContinuousResult(event) {
                var final_transcript = '';
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    final_transcript += event.results[i][0].transcript;
                }
                return final_transcript;
            }

            function extractNonContinuousResult(event) {
                return event.results[0][0].transcript;
            }

            recognition.onstart = function(){
                console.log('onstart');
            }
            recognition.onend = function(){
                console.log('onend');
            }
            recognition.onerror = function(){
                console.log('onerror');
            }
            recognition.onresult = function(event) {
                console.log('onresult', event);
                console.log('event.resultIndex', event.resultIndex);
                appendToOutput(recognition.continuous ? extractContinuousResult(event) : extractNonContinuousResult(event));
            }
            recognition.onnomatch = function(){
                console.log('onnomatch');
            }

            recognition.onspeechstart = function(){
                console.log('onspeechstart');
            }
            recognition.onspeechend = function(){
                console.log('onspeechend');
                stopRecognition();
            };

            recognition.onaudiostart = function(){
                console.log('onaudiostart');
            }
            recognition.onaudioend = function(){
                console.log('onaudioend');
            }

            recognition.onsoundstart = function(){
                console.log('onsoundstart');
            }
            recognition.onsoundend = function(){
                console.log('onsoundend');
            }

            theButton.click(function () {
                if(currentSpeech.recog !== recognition && currentSpeech.stopCallback) {
                    currentSpeech.stopCallback();
                }

                if (theContainer.hasClass('is-recording')) {
                    stopRecognition();
                } else if(theContainer.hasClass('not-recording')) {
                    startRecognition();
                    currentSpeech.recog = recognition;
                    currentSpeech.stopCallback = stopRecognition;
                }
            });
        }

        function unsupportedEach(idx, el) {
            var theContainer = $(el);
            var theButton = theContainer.find('button[data-speech-record="true"]');
            theButton.click(function(){
                alert('Sorry, your browser does not support speech to text.');
            });
         }

        function initializeSpeech(isSupported) {
            if(typeof isSupported === 'undefined') {
                isSupported = true;
            }

            $('[data-speech="true"]').each(isSupported ? supportedEach : unsupportedEach);

            if(!isSupported){
                $('#unsupported-message').removeClass('d-none');
            }
        }

        $(document).ready(function () {
            initializeSpeech(typeof SpeechRecognition !== 'undefined');
        });
    </script>
</body>

</html>